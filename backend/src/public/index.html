<!DOCTYPE html>
<html>
<head>
    <title>Red Tetris</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .game-info {
            margin: 20px;
        }
        .hidden {
            display: none;
        }
        .players-list {
            margin: 10px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        .leader {
            font-weight: bold;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div id="gameSection" class="game-info">
        <h2>Room: <span id="currentRoom"></span></h2>
        <div id="roomInfo">
            <p>Votre pseudo: <span id="currentPlayer"></span></p>
            <div class="players-list">
                <h3>Joueurs connectés:</h3>
                <div id="playersList"></div>
            </div>
            <div id="gameControls">
                <button id="startGameBtn" class="hidden">Démarrer la partie</button>
            </div>
        </div>
        <div id="status"></div>
    </div>

    <script>
        const socket = io();
        let isLeader = false;

        // Récupérer room et player_name depuis l'URL
        const pathParts = window.location.pathname.split('/').filter(Boolean);
        const room = pathParts[0];
        const playerName = pathParts[1];

        if (!room || !playerName) {
            document.body.innerHTML = `
                <div style="margin: 20px; color: red;">
                    <h2>URL invalide</h2>
                    <p>Format correct: http://serveur:port/[room]/[pseudo]</p>
                    <p>Exemple: http://localhost:3000/room1/joueur1</p>
                </div>
            `;
        }
        
        function updateStatus(message) {
            document.getElementById('status').innerHTML += `<p>${message}</p>`;
        }

        function updatePlayersList(players) {
            const playersDiv = document.getElementById('playersList');
            playersDiv.innerHTML = players.map(player => 
                `<div class="${player.isLeader ? 'leader' : ''}">
                    ${player.name} ${player.isLeader ? '(Leader)' : ''}
                </div>`
            ).join('');

            const startButton = document.getElementById('startGameBtn');
            if (isLeader) {
                startButton.classList.remove('hidden');
            } else {
                startButton.classList.add('hidden');
            }
        }

        socket.on('connect', async () => {
            updateStatus('Connecté au serveur');
            
            // Une fois connecté, on initialise la room/joueur
            if (room && playerName) {
                try {
                    // Créer/joindre la room
                    const response = await fetch(`/${room}/${playerName}`, {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    // Initialiser le socket
                    socket.emit('init-player', {
                        pseudo: playerName,
                        room: room
                    });
                } catch (error) {
                    updateStatus(`Erreur: ${error}`);
                }
            }
        });

        socket.on('room-update', (data) => {
            updatePlayersList(data.players);
            const currentPlayerId = socket.id;
            const currentPlayer = data.players.find(p => p.id === currentPlayerId);
            if (currentPlayer) {
                isLeader = currentPlayer.isLeader;
            }
        });

        socket.on('joined-room', (data) => {
            document.getElementById('currentRoom').textContent = data.room;
            document.getElementById('currentPlayer').textContent = 
                data.players.find(p => p.id === data.playerId).name;
            
            updatePlayersList(data.players);
            const currentPlayer = data.players.find(p => p.id === data.playerId);
            isLeader = currentPlayer.isLeader;
        });

        socket.on('error', (error) => {
            updateStatus(`Erreur: ${error.message}`);
        });


        document.getElementById('startGameBtn').addEventListener('click', function() {
            if (isLeader) {
                // Émettre un événement au serveur pour démarrer la partie
                socket.emit('start-game', { room: room });
                updateStatus('Démarrage de la partie...');
            }
        });

        // Ajoutez aussi ces écouteurs d'événements pour gérer les réponses du serveur
        socket.on('game-started', (data) => {
            updateStatus('La partie a commencé!');
            // Ici vous pourrez ajouter le code pour initialiser l'interface du jeu
        });

        socket.on('game-update', (data) => {
            // Ici vous pourrez mettre à jour l'état du jeu (plateau, score, etc.)
            updateStatus(`Mise à jour du jeu reçue`);
        });
    </script>
</body>
</html>